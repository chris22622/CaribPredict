# CaribPredict Auto-Question Generation System

## Overview

This system automatically generates prediction market questions by scraping real Caribbean news via Brave Search and using Claude AI to create relevant, engaging questions for each CARICOM country.

## Architecture

### Components

1. **Brave Search Integration** (`lib/brave-search.ts`)
   - Searches for recent news articles for Caribbean countries
   - Filters results by freshness (last 7 days by default)
   - Returns structured news article data

2. **Claude AI Generator** (`lib/claude-generator.ts`)
   - Uses Claude Sonnet 4.5 to generate prediction questions
   - Processes news articles into structured questions
   - Validates output format and quality

3. **API Endpoint** (`app/api/auto-generate/route.ts`)
   - POST endpoint to trigger question generation
   - GET endpoint to check system status
   - Handles single country or all CARICOM countries

4. **CLI Script** (`scripts/generate-questions.ts`)
   - Manual execution or cron scheduling
   - Can target specific countries or process all
   - Comprehensive logging and error handling

5. **Admin Interface** (`app/admin/questions/page.tsx`)
   - Review pending questions
   - Approve to create live markets
   - Reject unsuitable questions
   - View source articles

6. **Approval API** (`app/api/questions/approve/route.ts`, `app/api/questions/reject/route.ts`)
   - Handles approval workflow
   - Creates markets and options in database
   - Updates queue status

## CARICOM Countries Supported

The system generates questions for all 15 CARICOM countries:

- Jamaica
- Trinidad and Tobago
- Barbados
- Bahamas
- Guyana
- Suriname
- Haiti
- Belize
- Antigua and Barbuda
- Saint Lucia
- Grenada
- Dominica
- Saint Kitts and Nevis
- Saint Vincent and the Grenadines
- Montserrat

## Usage

### Method 1: CLI Script (Recommended for Automation)

Generate questions for all countries:
```bash
npm run generate-questions
```

Generate questions for a specific country:
```bash
npm run generate-questions:country Jamaica
```

Or directly with tsx:
```bash
npx tsx scripts/generate-questions.ts
npx tsx scripts/generate-questions.ts "Trinidad and Tobago"
```

### Method 2: API Endpoint

Generate for all countries:
```bash
curl -X POST http://localhost:3000/api/auto-generate
```

Generate for specific country:
```bash
curl -X POST http://localhost:3000/api/auto-generate \
  -H "Content-Type: application/json" \
  -d '{"country":"Jamaica"}'
```

Check status:
```bash
curl http://localhost:3000/api/auto-generate
```

### Method 3: Admin Interface

1. Navigate to `/admin/questions` in your browser
2. View pending questions generated by the system
3. Click "Expand" to see full details and source articles
4. Click "Approve" to create live markets
5. Click "Reject" to dismiss poor quality questions

## Workflow

```
┌─────────────────┐
│  Brave Search   │  Searches for "{country} news"
│  API Call       │  Returns top 10 recent articles
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Claude AI      │  Analyzes articles
│  API Call       │  Generates 2-3 questions per country
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Save to        │  Stores in question_queue table
│  question_queue │  Status: pending
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Admin Review   │  Human reviews questions
│  /admin/questions│  Approves or rejects
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Create Market  │  Approved questions → live markets
│  markets table  │  Rejected → marked rejected
└─────────────────┘
```

## Database Schema

### question_queue Table

```sql
CREATE TABLE question_queue (
  id UUID PRIMARY KEY,
  brave_search_query TEXT,           -- "Jamaica news"
  country TEXT,                       -- "Jamaica"
  raw_news JSONB,                     -- Array of NewsArticle objects
  claude_prompt TEXT,                 -- Prompt sent to Claude
  generated_questions JSONB,          -- Array of GeneratedQuestion objects
  status TEXT DEFAULT 'pending',     -- pending, approved, rejected
  approved_by UUID,                   -- User who approved
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ
);
```

## Environment Variables

Required in `.env.local`:

```env
# Brave Search API
BRAVE_API_KEY=your_brave_api_key_here

# Claude AI API
CLAUDE_API_KEY=your_anthropic_api_key_here

# Supabase (already configured)
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

## Rate Limits & Costs

### Brave Search API
- Free tier: 2,000 queries/month
- Rate: ~1 query per country
- Recommendation: 1.5 second delay between requests

### Claude API (Sonnet 4.5)
- Pay per use model
- ~$0.003 per request (varies by token usage)
- Rate: ~1 request per country
- Recommendation: 2 second delay between requests

### Monthly Estimates
- Running for all 15 countries:
  - Brave API: 15 queries per run
  - Claude API: 15 requests per run
  - Weekly runs: ~60 queries/month (well within free tier)
  - Claude cost: ~$0.20/month (60 requests)

## Question Quality Guidelines

Claude is instructed to generate questions that:

1. **Are Binary or Multiple Choice** (2-5 options)
2. **Have Clear Resolution Criteria** - Must be verifiable with public data
3. **Are Interesting to Caribbean Users** - Relevant local topics
4. **Have Specific Close Dates** - 30-180 days from generation
5. **Avoid Sensitive Topics** - No violence, disasters, personal attacks
6. **Focus on Positive Topics** - Sports, economics, politics, culture, tech

### Categories
- Politics
- Sports
- Economics
- Technology
- Entertainment
- Culture
- Education
- Infrastructure

## Automation with Cron

### Linux/Mac Cron Job

Edit crontab:
```bash
crontab -e
```

Add weekly run (every Monday at 9 AM):
```cron
0 9 * * 1 cd /path/to/CaribPredict && npm run generate-questions >> /var/log/caribpredict-generation.log 2>&1
```

### Windows Task Scheduler

1. Open Task Scheduler
2. Create Basic Task
3. Set trigger: Weekly, Monday, 9:00 AM
4. Action: Start a program
5. Program: `cmd.exe`
6. Arguments: `/c cd "D:\Bot Projects\CaribPredict" && npm run generate-questions`

## Monitoring & Logging

### Check Generation Logs

Script logs to console with detailed progress:
```
============================================================
CaribPredict Question Generation Script
============================================================
Countries: Jamaica, Trinidad and Tobago, ...
Date: 2026-02-09T10:30:00.000Z
============================================================

Step 1/3: Searching for news articles...
------------------------------------------------------------
  Jamaica: 10 articles
  Trinidad and Tobago: 8 articles
  ...
  Total: 127 articles

Step 2/3: Generating questions with Claude AI...
------------------------------------------------------------
  Jamaica: 3 questions
  Trinidad and Tobago: 2 questions
  ...
  Total: 35 questions

Step 3/3: Saving to question queue...
------------------------------------------------------------
  Jamaica: Saved 3 questions (ID: abc-123)
  Trinidad and Tobago: Saved 2 questions (ID: def-456)
  ...

============================================================
Summary:
------------------------------------------------------------
Countries processed: 15
Total articles fetched: 127
Total questions generated: 35
Successfully saved: 15
Errors: 0
============================================================
```

### Query Database

Check pending questions:
```sql
SELECT country, COUNT(*) as pending_count
FROM question_queue
WHERE status = 'pending'
GROUP BY country;
```

Check recent generations:
```sql
SELECT
  country,
  status,
  array_length(generated_questions, 1) as question_count,
  created_at
FROM question_queue
ORDER BY created_at DESC
LIMIT 10;
```

## Troubleshooting

### No Articles Found
- Check BRAVE_API_KEY is valid
- Verify internet connection
- Check API rate limits not exceeded
- Try single country test: `npx tsx scripts/generate-questions.ts Jamaica`

### Claude Generation Fails
- Check CLAUDE_API_KEY is valid
- Verify API quota not exceeded
- Check Claude API status
- Review error messages in console

### Questions Not Appearing in Admin
- Verify database connection
- Check Supabase service role key
- Query question_queue table directly
- Review console logs for errors

### Approval Creates No Markets
- Check markets table permissions
- Verify market_options creation
- Review API route logs
- Check for database constraint violations

## Security Considerations

1. **API Keys**: Never commit API keys to version control
2. **Service Role Key**: Only used server-side for admin operations
3. **Input Validation**: All country names validated against whitelist
4. **Rate Limiting**: Delays prevent API abuse
5. **Admin Access**: Consider adding authentication to /admin routes

## Future Enhancements

1. **Email Notifications**: Alert admins when new questions are ready
2. **Question Scoring**: ML model to predict question quality
3. **Auto-Approval**: Automatically approve high-confidence questions
4. **Trending Topics**: Prioritize questions based on article engagement
5. **Multi-Language**: Generate questions in English and local languages
6. **Performance Metrics**: Track approval rates by country/category
7. **A/B Testing**: Test different prompt variations
8. **Source Diversity**: Pull from multiple news sources beyond Brave

## Support

For issues or questions:
1. Check logs for error messages
2. Verify environment variables are set
3. Test with single country first
4. Review database for saved questions
5. Check API quotas and limits

## License

Part of the CaribPredict platform.
